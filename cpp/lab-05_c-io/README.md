# Лабораторная №5: ввод-вывод со стандартной библиотекой Си.

> Кодовое название: `lab-05_c-io`.

## Содержание
1. [Содержание](#содержание)
1. [Задание](#задание)
1. [Требования к корректности решения](#требования-к-корректности-решения)
    1. [Стандартные требования](#стандартные-требования)
    1. [Формат текстовых файлов](#формат-текстовых-файлов)
    1. [Формат бинарных файлов](#формат-бинарных-файлов)
    1. [Консольное приложение](#консольное-приложение)
    1. [Реализация операций `print` и `count`](#реализация-операций-print-и-count)
    1. [Разделение обязанностей](#разделение-обязанностей)
    1. [Структура репозитория](#структура-репозитория)
    1. [Бонусное задание](#бонусное-задание)
1. [Сроки сдачи](#сроки-сдачи)
1. [Система оценки](#система-оценки)

## Задание
В лабораторной №4 (`lab-04_intrusive-list`) была реализована «база данных», хранящая точки в памяти.
В лабораторной №5 предлагается добавить возможность хранить точки на диске в двух форматах:
текстовом и двоичном (бинарном).

Реализуйте приложение `./lab-05_c-io`, которое умеет читать упорядоченный список точек из определённого
файла текстового или бинарного формата (описаны ниже) и выполнять следующие действия.

1. Сохранять прочитанные точки в другой файл в текстовом или бинарном формате.
1. Выводить все точки на экран в заданном в качестве параметра командной строки формате.
1. Выводить на экран количество точек.

Гарантируется, что координаты не превосходят 5'000'000 по модулю (пять миллионов).

Для выполнения этого задания вам понадобится реализация интрузивного списка для точек.
Можно использовать либо свою (из лабораторной №4), либо, после наступления дедлайна в вашей группе по предыдущей
лабораторной, запросить у преподавателя решение.

## Требования к корректности решения
### Стандартные требования
Смотри стандартные требования из предыдущих заданий.

Требования на автоматические тесты остаются, но неактуальны, потому что автоматические тесты
в задании реализовывать не надо.
При желании вы можете реализовать свои тесты (смотри общие требования).

### Формат текстовых файлов
Текстовой файл, содержащий `N` точек, состоит из `N` строк.
Каждая строка заканчивается символом перевода строки.
В каждой строчке содержится ровно два целых числа, разделённых ровно одним пробелом:
`x`-координата точки и `y`-координата точки.
Другие символы в файле отсутствуют, лидирующие нули отсутствуют.

Помните, что стандартные функции ввода-вывода корректно заменяют `\n`
на нужный конкретной ОС перевод строки, не надо это обрабатывать руками.

### Формат бинарных файлов
Бинарный файл, содержащий `N` точек, состоит из `6N` байт.
Каждая точка хранится как 6 подряд идущих байт: три байта хранят координату
`x`, а следующие три байта хранят координату `y`.

Неотрицательные числа хранятся побайтово: от младших байтов к старшим.
Например, число 1000 должно храниться как три последовательных байта со
значениями `232, 3, 0`.

### Консольное приложение
Приложение запускается следующей командой:

```
./lab-05_c-io (loadtext | loadbin) <infile> <action...>
```

Здесь используются следующие параметры.

* `(loadtext | loadbin)` определяет вид входного файла: `loadtext` для текстового, `loadbin` для
  двоичного. Один параметр.
* `<infile>` — относительный путь к входному файлу, который хранит точки. Один параметр.
* `<action...>` — операция, которую нужно выполнить над точками. Один или более параметров, которые
  могут принимать значения в соответствие с ровно одним из следующих вариантов:
  * `(savetext | savebin) <outfile>` — сохранить считанные точки в файл `<outfile>` в текстовом
    (`savetext`) или бинарном (`savebin`) формате;
  * `print <fmt>` — вывести все точки на экран, использовать _printf_-строчку `<fmt>` для вывода.
    Должно встречаться ровно два спецификатора: первый `%d` соответствует `x`-координате, второй — 
    `y`-координате;
    разделители, не указанные в `<fmt>`, добавляться не должны (например, пробелы).
    После вывода ваша программа должна вывести перевод строки.
  * `count` — вывести на экран количество точек и перевод строки.

Гарантируется, что входной файл соответствует формату.

Пример работы:

```
$ cat test.txt
1 2
4 3
5 5
$ ./lab-05_c-io loadtext test.txt savetext out.txt
$ cat out.txt
1 2
4 3
5 5
$ ./lab-05_c-io loadtext test.txt count
3
$ ./lab-05_c-io loadtext test.txt print "[%d, %d] "
[1, 2] [4, 3] [5, 5] 
$ ./lab-05_c-io loadtext test.txt print "[%d, %d]"
[1, 2][4, 3][5, 5]
$ ./lab-05_c-io loadtext test.txt savebin out.bin
$ hexdump -C out.bin
00000000  01 00 00 02 00 00 04 00  00 03 00 00 05 00 00 05  |................|
00000010  00 00                                             |..|
00000012
$ ./lab-05_c-io loadbin out.bin print "%d %d "
1 2 4 3 5 5 
```

### Реализация операций `print` и `count`
Операции `print` и `count` требуется реализовать, используя функцию `apply`.
Использовать `get_length` для реализации `count` в этом задании запрещается.

Функция `apply` выполняет некоторую унарную операцию на каждом элементе списка
(например, вывод на экран).
Она должна быть реализована в файлах `clist.h` и `clist.c` и работать для списков
из элементов произвольного типа:

```c
void apply(intrusive_list *list, void (*op)(intrusive_node *node, void *data), void *data);
```

Здесь параметр `data` функция `apply` не использует напрямую, а передаёт в функцию `op` как 
дополнительный параметр. Это нужно, чтобы можно было не меняя сигнатуру `apply` передавать в `op`,
помимо элемента списка, произвольные параметры. Также `data` можно использовать для получения из
`op` произвольных значений.

### Разделение обязанностей
* Файлы `clist.c` и `clist.h` должны содержать корректную реализацию интрузивного списка (см.
  лабораторную 4).
* Файлы `point_list.c` и `point_list.h` должны содержать корректную реализацию функций для работы
  с интрузивным списком точек из лабораторной 4.
* Вы также можете реализовать функции записи и чтения файлов через `apply`.

### Структура репозитория
```
<корень-личного-репозитория>
╰╼ lab-05_c-io
   ├╼ include
   │  ├╼ clist.h
   │  ╰╼ point_list.h
   ├╼ Makefile
   ╰╼ src
      ├╼ clist.c
      ├╼ main.c
      ╰╼ point_list.c
```

Папку `obj`, объектные и исполняемые файлы класть в репозиторий не разрешается.

### Бонусное задание
Если ваше приложение корректно и также корректно обработает хранение отрицательных целых чисел в 
[дополнительном коде][ru-wiki-twos-complement] в бинарных файлах, то вы получаете бонусные **+2** балла.

Точные правила уточняйте у своего преподавателя.

## Сроки сдачи

Уточняйте у своего преподавателя.

## Система оценки

* Задание оценивается в 10 баллов: 7 за корректность и 3 за стиль.
* Точные критерии оценки каждой из частей остаются на усмотрение преподавателя.
* Вы можете получить ещё +2 балла за [бонусное задание](#бонусное-задание), итого 12.

[ru-wiki-twos-complement]: https://ru.wikipedia.org/wiki/%D0%94%D0%BE%D0%BF%D0%BE%D0%BB%D0%BD%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D0%B9_%D0%BA%D0%BE%D0%B4
